---
- name: run preliminary tasks
  import_tasks: prelim.yml
  become: yes
  tags:
    - prelim_tasks

- name: "CAT I | RHEL-07-010010 | The Red Hat Enterprise Linux operating system must be configured so that the file permissions, ownership, and group membership of system files and commands match the vendor values."
  block:
    - name: Check for packages with incorrect permissions
      shell: |
        ( for i in `rpm -Va --nodeps --nosignature --nofiledigest --nosize --nomtime --nordev --nocaps --nolinkto --nouser --nogroup | egrep -i '^\.[M|U|G|.]{8}' | cut -d " " -f4,5`; do rpm -qf $i;done )
      args:
        warn: false
      register: packages_with_incorrect_permissions
      failed_when: packages_with_incorrect_permissions.rc > 1
      changed_when: false
    - name: Correct package ownership and permissions
      shell: |
        ( rpm --setugids "{{ item }}"; rpm --setperms "{{ item }}" )
      args:
        warn: false
      with_items: '{{ packages_with_incorrect_permissions.stdout_lines }}'
      when:
        - (packages_with_incorrect_permissions.stdout_lines | length > 0)
  tags:
      - CAT-I
      - RHEL-07-010010

- name: "CAT I | RHEL-07-010020 | The Red Hat Enterprise Linux operating system must be configured so that the cryptographic hash of system files and commands matches vendor values."
  block:
    - name: Check for packages with incorrect cryptographic integrity
      shell: |
        ( for i in `rpm -Va --noconfig --nolinkto --nosize --nouser --nogroup --nomtime --nomode --nodigest --nosignature | egrep -i '^..5' | cut -d " " -f4,5`; do rpm -qf $i;done )
      args:
        warn: false
      register: packages_with_incorrect_crypto
      failed_when: packages_with_incorrect_crypto.rc > 1
      changed_when: false
    - name: Correct package cryptographic integrity
      shell: |
        ( yum reinstall -y {{ item }} )
      args:
        warn: false
      register: package_fix_crypto
      failed_when: package_fix_crypto.rc > 1
      with_items: '{{ packages_with_incorrect_crypto.stdout_lines }}'
      when:
        - (packages_with_incorrect_crypto.stdout_lines | length > 0)
  tags:
      - CAT-I
      - RHEL-07-010020

- name: "CAT II | RHEL-07-010030 | The Red Hat Enterprise Linux operating system must display the Standard Mandatory DoD Notice and Consent Banner before granting local or remote access to the system via a graphical user logon."
  block:
    - name: Check if the DoD banner is shown with a graphical logon
      shell: |
        if rpm -qa|grep -qs gnome; then
          currstatus=$(sed -n -r "/^\s*\[org\/gnome\/login-screen\]\s*$/,/^\s*\[/ s/^\s*banner-message-enable\s*=\s*(.*)$/\1/p" /etc/dconf/db/local.d/01-banner-message)
          if [[ "${currstatus}" == "true" ]]; then
            exit 0
          else
            exit 1
          fi
        else
          exit 0
        fi
      args:
        warn: false
      register: gui_banner_enable_check
      failed_when: gui_banner_enable_check.rc > 1
      changed_when: false
    - name: Enable banner on graphical logon
      shell: |
        filename="/etc/dconf/db/local.d/01-banner-message"
        section="\[org\/gnome\/login-screen\]"
        regsection="[org/gnome/login-screen]"
        varname="banner-message-enable"
        if [[ ! -f $filename ]] || sed -n "/^\s*${section}\s*$/q 1" $filename; then
            echo $regsection >> $filename
        fi
        sed -n -r "/^\s*${section}\s*$/,/^\s*\[/{/^\s*${varname}/q 10}" $filename
        if [[ $? -eq 10 ]]; then
            sed -i -r "/^\s*${section}\s*$/,/^\s*\[/ s/^(\s*${varname}\s*=\s*).*$/\1true/" $filename
        else
            sed -i "/^\s*${section}\s*$/a ${varname}=true" $filename
        fi
      args:
        warn: false
      when:
        - (gui_banner_enable_check.rc > 0)
  tags:
      - CAT-II
      - RHEL-07-010030

- name: "CAT II | RHEL-07-010040 | The Red Hat Enterprise Linux operating system must display the approved Standard Mandatory DoD Notice and Consent Banner before granting local or remote access to the system via a graphical user logon."
  block:
    - name: Check for the correct DoD banner
      shell: |
        regcorrectstatus="'{{ logon_banner | regex_replace('(?s)(?<!\\n)\\n(?!(\n|$))', '') }}'"
        if rpm -qa|grep -qs gnome; then
          currstatus=$(sed -n -r "/^\s*\[org\/gnome\/login-screen\]\s*$/,/^\s*\[/ s/^\s*banner-message-text\s*=\s*(.*)$/\1/p" /etc/dconf/db/local.d/01-banner-message)
          if [[ "${currstatus}" == "${regcorrectstatus}" ]]; then
            exit 0
          else
            exit 1
          fi
        else
          exit 0
        fi
      args:
        warn: false
      register: gui_banner_correct_check
      failed_when: gui_banner_correct_check.rc > 1
      changed_when: false
    - name: Correct banner text on graphical logon
      shell: |
        filename="/etc/dconf/db/local.d/01-banner-message"
        section="\[org\/gnome\/login-screen\]"
        regsection="[org/gnome/login-screen]"
        varname="banner-message-text"
        correctstatus="'{{ logon_banner | regex_replace('(?s)(?<!\\n)\\n(?!(\n|$))', '') | regex_replace('(\(|\)|\.)', '\\\1') | regex_replace('(\\n)', '\\\\\1') }}'"
        if [[ ! -f $filename ]] || sed -n "/^\s*${section}\s*$/q 1" $filename; then
          echo "${regsection}" >> $filename
        fi
        sed -n -r "/^\s*${section}\s*$/,/^\s*\[/{/^\s*${varname}/q 10}" $filename
        if [[ $? -eq 10 ]]; then
          sed -i -r "/^\s*${section}\s*$/,/^\s*\[/ s/^(\s*${varname}\s*=\s*).*$/\1${correctstatus}/" $filename
        else
          sed -i "/^\s*${section}\s*$/a ${varname}=${correctstatus}" $filename
        fi
      args:
        warn: false
      when:
        - (gui_banner_correct_check.rc > 0)
  tags:
      - CAT-II
      - RHEL-07-010040

- name: "CAT II | RHEL-07-010050 | The Red Hat Enterprise Linux operating system must display the Standard Mandatory DoD Notice and Consent Banner before granting local or remote access to the system via a command line user logon."
  block:
    - name: Check for DoD banner for console logon
      shell: |
        correctstatus=$(echo -e "{{ logon_banner }}")
        if [[ $correctstatus == $(cat /etc/issue) ]]; then
          exit 0
        else
          exit 1
        fi
      args:
        warn: false
      register: console_banner_check
      failed_when: console_banner_check.rc > 1
      changed_when: false
    - name: Correct console logon banner
      shell: |
        echo -e "{{ logon_banner }}" > /etc/issue
      args:
        warn: false
      when:
        - (console_banner_check.rc > 0)
  tags:
     - CAT-II
     - RHEL-07-010050

- name: "CAT II | RHEL-07-010060 | The Red Hat Enterprise Linux operating system must enable a user session lock until that user re-establishes access using established identification and authentication procedures."
  block:
    - name: Check for session lock
      shell: |
        if rpm -qa|grep -qs gnome; then
          currstatus=$(sed -n -r "/^\s*\[org\/gnome\/desktop\/screensaver\]\s*$/,/^\s*\[/ s/^\s*lock-enabled\s*=\s*(.*)$/\1/p" /etc/dconf/db/local.d/00-screensaver)
          if [[ "${currstatus}" == "true" ]]; then
            exit 0
          else
            exit 1
          fi
        else
          exit 0
        fi
      args:
        warn: false
      register: gui_lock_enable_check
      failed_when: gui_lock_enable_check.rc > 1
      changed_when: false
    - name: Correct session lock
      shell: |
        filename="/etc/dconf/db/local.d/00-screensaver"
        section="\[org\/gnome\/desktop\/screensaver\]"
        regsection="[org/gnome/desktop/screensaver]"
        varname="lock-enabled"
        if [[ ! -f $filename ]] || sed -n "/^\s*${section}\s*$/q 1" $filename; then
            echo $regsection >> $filename
        fi
        sed -n -r "/^\s*${section}\s*$/,/^\s*\[/{/^\s*${varname}/q 10}" $filename
        if [[ $? -eq 10 ]]; then
            sed -i -r "/^\s*${section}\s*$/,/^\s*\[/ s/^(\s*${varname}\s*=\s*).*$/\1true/" $filename
        else
            sed -i "/^\s*${section}\s*$/a ${varname}=true" $filename
        fi
        dconf update
      args:
        warn: false
      register: testing
      when:
        - (gui_lock_enable_check.rc > 0)
  tags:
     - CAT-II
     - RHEL-07-010060

- name: "CAT II | RHEL-07-010061 | The Red Hat Enterprise Linux operating system must uniquely identify and must authenticate users using multifactor authentication via a graphical user logon."
  block:
    - name: Check for smartcard login
      shell: |
        if rpm -qa|grep -qs gnome; then
          currstatus=$(sed -n -r "/^\s*\[org\/gnome\/login-screen\]\s*$/,/^\s*\[/ s/^\s*enable-smartcard-authentication\s*=\s*(.*)$/\1/p" /etc/dconf/db/local.d/00-defaults)
          if [[ "${currstatus}" == "true" ]]; then
            exit 0
          else
            exit 1
          fi
        else
          exit 0
        fi
      args:
        warn: false
      register: smartcard_enable_check
      failed_when: smartcard_enable_check.rc > 1
      changed_when: false
    - name: Correct smartcard login
      shell: |
        filename="/etc/dconf/db/local.d/00-defaults"
        section="\[org\/gnome\/login-screen\]"
        regsection="[org/gnome/login-screen]"
        varname="enable-smartcard-authentication"
        if [[ ! -f $filename ]] || sed -n "/^\s*${section}\s*$/q 1" $filename; then
            echo $regsection >> $filename
        fi
        sed -n -r "/^\s*${section}\s*$/,/^\s*\[/{/^\s*${varname}/q 10}" $filename
        if [[ $? -eq 10 ]]; then
            sed -i -r "/^\s*${section}\s*$/,/^\s*\[/ s/^(\s*${varname}\s*=\s*).*$/\1true/" $filename
        else
            sed -i "/^\s*${section}\s*$/a ${varname}=true" $filename
        fi
        dconf update
      args:
        warn: false
      when:
        - (smartcard_enable_check.rc > 0)
  tags:
     - CAT-II
     - RHEL-07-010061

- name: "CAT II | RHEL-07-010062 | The Red Hat Enterprise Linux operating system must prevent a user from overriding the screensaver lock-enabled setting for the graphical user interface."
  block:
    - name: Check for prevention of overriding lock setting
      shell: |
        if rpm -qa|grep -qs gnome; then
          grep -qsi "/org/gnome/desktop/screensaver/lock-enabled" /etc/dconf/db/local.d/locks/*
        fi
      args:
        warn: false
      register: lock_override_check
      failed_when: lock_override_check.rc > 2
      changed_when: false
    - name: Correct lock override prevention
      shell: |
        echo "/org/gnome/desktop/screensaver/lock-enabled" >> /etc/dconf/db/local.d/locks/session
      args:
        warn: false
      when:
        - (lock_override_check.rc > 0)
  tags:
      - CAT-II
      - RHEL-07-010062

- name: "CAT II | RHEL-07-010070 | The Red Hat Enterprise Linux operating system must initiate a screensaver after a 15-minute period of inactivity for graphical user interfaces."
  block:
    - name: Check for screensaver timeout
      shell: |
        if rpm -qa|grep -qs gnome; then
          currstatus=$(sed -n -r "/^\s*\[org\/gnome\/desktop\/session\]\s*$/,/^\s*\[/ s/^\s*idle-delay\s*=\s*(.*)$/\1/p" /etc/dconf/db/local.d/00-screensaver)
          if [[ "${currstatus}" == "uint32 900" ]]; then
            exit 0
          else
            exit 1
          fi
        else
          exit 0
        fi
      args:
        warn: false
      register: screensaver_timeout_check
      failed_when: screensaver_timeout_check.rc > 1
      changed_when: false
    - name: Correct screensaver timeout
      shell: |
        filename="/etc/dconf/db/local.d/00-screensaver"
        section="\[org\/gnome\/desktop\/session\]"
        regsection="[org/gnome/desktop/session]"
        varname="idle-delay"
        status="uint32 900"
        if [[ ! -f $filename ]] || sed -n "/^\s*${section}\s*$/q 1" $filename; then
            echo $regsection >> $filename
        fi
        sed -n -r "/^\s*${section}\s*$/,/^\s*\[/{/^\s*${varname}/q 10}" $filename
        if [[ $? -eq 10 ]]; then
            sed -i -r "/^\s*${section}\s*$/,/^\s*\[/ s/^(\s*${varname}\s*=\s*).*$/\1${status}/" $filename
        else
            sed -i "/^\s*${section}\s*$/a ${varname}=${status}" $filename
        fi
        dconf update
      args:
        warn: false
      when:
        - (screensaver_timeout_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010070

- name: "CAT II | RHEL-07-010081 | The Red Hat Enterprise Linux operating system must prevent a user from overriding the screensaver lock-delay setting for the graphical user interface."
  block:
    - name: Check for prevention of overriding timeout setting
      shell: |
        if rpm -qa|grep -qs gnome; then
          grep -qsi "/org/gnome/desktop/screensaver/lock-delay" /etc/dconf/db/local.d/locks/*
        fi
      args:
        warn: false
      register: timeout_override_check
      failed_when: timeout_override_check.rc > 2
      changed_when: false
    - name: Correct timeout override prevention
      shell: |
        echo "/org/gnome/desktop/screensaver/lock-delay" >> /etc/dconf/db/local.d/locks/session
      args:
        warn: false
      when:
        - (timeout_override_check.rc > 0)
  tags:
      - CAT-II
      - RHEL-07-010081

- name: "CAT II | RHEL-07-010082 | The Red Hat Enterprise Linux operating system must prevent a user from overriding the session idle-delay setting for the graphical user interface."
  block:
    - name: Check for prevention of overriding idle setting
      shell: |
        if rpm -qa|grep -qs gnome; then
          grep -qsi "/org/gnome/desktop/session/idle-delay" /etc/dconf/db/local.d/locks/*
        fi
      args:
        warn: false
      register: idle_override_check
      failed_when: idle_override_check.rc > 2
      changed_when: false
    - name: Correct timeout override prevention
      shell: |
        echo "/org/gnome/desktop/session/idle-delay" >> /etc/dconf/db/local.d/locks/session
      args:
        warn: false
      when:
        - (idle_override_check.rc > 0)
  tags:
      - CAT-II
      - RHEL-07-010082

- name: "CAT II | RHEL-07-010090 | The Red Hat Enterprise Linux operating system must have the screen package installed."
  block:
    - name: Check for screen or tmux installation
      shell: |
        yum list installed|grep -qs '^screen\.\|^tmux\.'
      args:
        warn: false
      register: screen_check
      ignore_errors: true
      changed_when: false
  tags:
      - CAT-II
      - RHEL-07-010090

- name: "CAT II | RHEL-07-010100 | The Red Hat Enterprise Linux operating system must initiate a session lock for the screensaver after a period of inactivity for graphical user interfaces."
  block:
    - name: Check for lock timeout
      shell: |
        if rpm -qa|grep -qs gnome; then
          currstatus=$(sed -n -r "/^\s*\[org\/gnome\/desktop\/screensaver\]\s*$/,/^\s*\[/ s/^\s*idle-activation-enabled\s*=\s*(.*)$/\1/p" /etc/dconf/db/local.d/00-screensaver)
          if [[ "${currstatus}" == "true" ]]; then
            exit 0
          else
            exit 1
          fi
        else
          exit 0
        fi
      args:
        warn: false
      register: gui_idle_activation_check
      failed_when: gui_idle_activation_check.rc > 1
      changed_when: false
    - name: Correct session lock
      shell: |
        filename="/etc/dconf/db/local.d/00-screensaver"
        section="\[org\/gnome\/desktop\/screensaver\]"
        regsection="[org/gnome/desktop/screensaver]"
        varname="idle-activation-enabled"
        if [[ ! -f $filename ]] || sed -n "/^\s*${section}\s*$/q 1" $filename; then
            echo $regsection >> $filename
        fi
        sed -n -r "/^\s*${section}\s*$/,/^\s*\[/{/^\s*${varname}/q 10}" $filename
        if [[ $? -eq 10 ]]; then
            sed -i -r "/^\s*${section}\s*$/,/^\s*\[/ s/^(\s*${varname}\s*=\s*).*$/\1true/" $filename
        else
            sed -i "/^\s*${section}\s*$/a ${varname}=true" $filename
        fi
        dconf update
      args:
        warn: false
      register: testing
      when:
        - (gui_idle_activation_check.rc > 0)
  tags:
     - CAT-II
     - RHEL-07-010100

- name: "CAT II | RHEL-07-010101 | The Red Hat Enterprise Linux operating system must prevent a user from overriding the screensaver idle-activation-enabled setting for the graphical user interface."
  block:
    - name: Check for prevention of overriding idle activation setting
      shell: |
        if rpm -qa|grep -qs gnome; then
          grep -qsi "/org/gnome/desktop/screensaver/idle-activation-enabled" /etc/dconf/db/local.d/locks/*
        fi
      args:
        warn: false
      register: idle_activation_override_check
      failed_when: idle_activation_override_check.rc > 2
      changed_when: false
    - name: Correct idle activation override prevention
      shell: |
        echo "/org/gnome/desktop/screensaver/idle-activation-enabled" >> /etc/dconf/db/local.d/locks/session
      args:
        warn: false
      when:
        - (idle_activation_override_check.rc > 0)
  tags:
      - CAT-II
      - RHEL-07-010101

- name: "CAT II | RHEL-07-010110 | The Red Hat Enterprise Linux operating system must initiate a session lock for graphical user interfaces when the screensaver is activated."
  block:
    - name: Check for screensaver delay
      shell: |
        if rpm -qa|grep -qs gnome; then
          currstatus=$(sed -n -r "/^\s*\[org\/gnome\/desktop\/screensaver\]\s*$/,/^\s*\[/ s/^\s*lock-delay\s*=\s*(.*)$/\1/p" /etc/dconf/db/local.d/00-screensaver)
          if [[ "${currstatus}" == "uint32 5" ]]; then
            exit 0
          else
            exit 1
          fi
        else
          exit 0
        fi
      args:
        warn: false
      register: screensaver_delay_check
      failed_when: screensaver_delay_check.rc > 1
      changed_when: false
    - name: Correct screensaver delay
      shell: |
        filename="/etc/dconf/db/local.d/00-screensaver"
        section="\[org\/gnome\/desktop\/screensaver\]"
        regsection="[org/gnome/desktop/screensaver]"
        varname="lock-delay"
        status="uint32 5"
        if [[ ! -f $filename ]] || sed -n "/^\s*${section}\s*$/q 1" $filename; then
            echo $regsection >> $filename
        fi
        sed -n -r "/^\s*${section}\s*$/,/^\s*\[/{/^\s*${varname}/q 10}" $filename
        if [[ $? -eq 10 ]]; then
            sed -i -r "/^\s*${section}\s*$/,/^\s*\[/ s/^(\s*${varname}\s*=\s*).*$/\1${status}/" $filename
        else
            sed -i "/^\s*${section}\s*$/a ${varname}=${status}" $filename
        fi
        dconf update
      args:
        warn: false
      when:
        - (screensaver_delay_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010110

- name: "CAT II | RHEL-07-010118 | The Red Hat Enterprise Linux operating system must be configured so that /etc/pam.d/passwd implements /etc/pam.d/system-auth when changing passwords."
  block:
    - name: Check for system-auth on password change
      shell: |
        grep -qs "^password\s\+substack\s\+system-auth" /etc/pam.d/passwd
      args:
        warn: false
      register: system_auth_passwd_check
      failed_when: system_auth_passwd_check.rc > 1
      changed_when: false
    - name: Correct system-auth on password change
      shell: |
        echo "password substack system-auth" >> /etc/pam.d/passwd
      args:
        warn: false
      when:
        - (system_auth_passwd_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010118

- name: "CAT II | RHEL-07-010119 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are established, pwquality must be used."
  block:
    - name: Check for password quality
      shell: |
        grep -qs "^password required pam_pwquality.so retry=3" /etc/pam.d/passwd
      args:
        warn: false
      register: pam_pwquality_check
      failed_when: pam_pwquality_check.rc > 1
      changed_when: false
    - name: Correct system-auth password quality
      shell: |
        if grep -qs pwquality /etc/pam.d/passwd; then
          sed -in 's/password\s\+required\s\+pam_pwquality.so\s\+retry=.*/password required pam_pwquality.so retry=3/' /etc/pam.d/passwd
        else
          echo "password required pam_pwquality.so retry=3" >> /etc/pam.d/passwd
        fi
      args:
        warn: false
      when:
        - (pam_pwquality_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010119

- name: "CAT II | RHEL-07-010120 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are established, the new password must contain at least one upper-case character."
  block:
    - name: Check for upper case password requirement
      shell: |
        grep -qs "^ucredit = -1" /etc/security/pwquality.conf
      args:
        warn: false
      register: pwquality_upper_case_check
      failed_when: pwquality_upper_case_check.rc > 1
      changed_when: false
    - name: Correct pwquality upper case requirement
      shell: |
        rule="ucredit"
        correct="-1"
        if grep -qs "^${rule}" /etc/security/pwquality.conf; then
          sed -in "s/^${rule} = .*/${rule} = ${correct}/" /etc/security/pwquality.conf
        else
          echo "${rule} = ${correct}" >> /etc/security/pwquality.conf
        fi
      args:
        warn: false
      when:
        - (pwquality_upper_case_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010120

- name: "CAT II | RHEL-07-010130 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are established, the new password must contain at least one lower-case character."
  block:
    - name: Check for lower case password requirement
      shell: |
        grep -qs "^lcredit = -1" /etc/security/pwquality.conf
      args:
        warn: false
      register: pwquality_lower_case_check
      failed_when: pwquality_lower_case_check.rc > 1
      changed_when: false
    - name: Correct pwquality lower case requirement
      shell: |
        rule="lcredit"
        correct="-1"
        if grep -qs "^${rule}" /etc/security/pwquality.conf; then
          sed -in "s/^${rule} = .*/${rule} = ${correct}/" /etc/security/pwquality.conf
        else
          echo "${rule} = ${correct}" >> /etc/security/pwquality.conf
        fi
      args:
        warn: false
      when:
        - (pwquality_lower_case_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010130

- name: "CAT II | RHEL-07-010140 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are assigned, the new password must contain at least one numeric character."
  block:
    - name: Check for numeric password requirement
      shell: |
        grep -qs "^dcredit = -1" /etc/security/pwquality.conf
      args:
        warn: false
      register: pwquality_numeric_check
      failed_when: pwquality_numeric_check.rc > 1
      changed_when: false
    - name: Correct pwquality numeric requirement
      shell: |
        rule="dcredit"
        correct="-1"
        if grep -qs "^${rule}" /etc/security/pwquality.conf; then
          sed -in "s/^${rule} = .*/${rule} = ${correct}/" /etc/security/pwquality.conf
        else
          echo "${rule} = ${correct}" >> /etc/security/pwquality.conf
        fi
      args:
        warn: false
      when:
        - (pwquality_numeric_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010140

- name: "CAT II | RHEL-07-010150 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are established, the new password must contain at least one special character."
  block:
    - name: Check for special character password requirement
      shell: |
        grep -qs "^ocredit = -1" /etc/security/pwquality.conf
      args:
        warn: false
      register: pwquality_special_check
      failed_when: pwquality_special_check.rc > 1
      changed_when: false
    - name: Correct pwquality special character requirement
      shell: |
        rule="ocredit"
        correct="-1"
        if grep -qs "^${rule}" /etc/security/pwquality.conf; then
          sed -in "s/^${rule} = .*/${rule} = ${correct}/" /etc/security/pwquality.conf
        else
          echo "${rule} = ${correct}" >> /etc/security/pwquality.conf
        fi
      args:
        warn: false
      when:
        - (pwquality_special_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010150

- name: "CAT II | RHEL-07-010160 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed a minimum of eight of the total number of characters must be changed."
  block:
    - name: Check for password length requirement
      shell: |
        grep -qs "^difok = 8" /etc/security/pwquality.conf
      args:
        warn: false
      register: pwquality_length_check
      failed_when: pwquality_length_check.rc > 1
      changed_when: false
    - name: Correct pwquality length requirement
      shell: |
        rule="difok"
        correct="8"
        if grep -qs "^${rule}" /etc/security/pwquality.conf; then
          sed -in "s/^${rule} = .*/${rule} = ${correct}/" /etc/security/pwquality.conf
        else
          echo "${rule} = ${correct}" >> /etc/security/pwquality.conf
        fi
      args:
        warn: false
      when:
        - (pwquality_length_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010160

- name: "CAT II | RHEL-07-010170 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed a minimum of four character classes must be changed."
  block:
    - name: Check for password change requirement
      shell: |
        grep -qs "^minclass = 4" /etc/security/pwquality.conf
      args:
        warn: false
      register: pwquality_change_check
      failed_when: pwquality_change_check.rc > 1
      changed_when: false
    - name: Correct pwquality change requirement
      shell: |
        rule="minclass"
        correct="4"
        if grep -qs "^${rule}" /etc/security/pwquality.conf; then
          sed -in "s/^${rule} = .*/${rule} = ${correct}/" /etc/security/pwquality.conf
        else
          echo "${rule} = ${correct}" >> /etc/security/pwquality.conf
        fi
      args:
        warn: false
      when:
        - (pwquality_change_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010170

- name: "CAT II | RHEL-07-010180 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed the number of repeating consecutive characters must not be more than three characters."
  block:
    - name: Check for password character repeat requirement
      shell: |
        grep -qs "^maxrepeat = 3" /etc/security/pwquality.conf
      args:
        warn: false
      register: pwquality_repeat_check
      failed_when: pwquality_repeat_check.rc > 1
      changed_when: false
    - name: Correct pwquality character repeat requirement
      shell: |
        rule="maxrepeat"
        correct="3"
        if grep -qs "^${rule}" /etc/security/pwquality.conf; then
          sed -in "s/^${rule} = .*/${rule} = ${correct}/" /etc/security/pwquality.conf
        else
          echo "${rule} = ${correct}" >> /etc/security/pwquality.conf
        fi
      args:
        warn: false
      when:
        - (pwquality_repeat_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010180

- name: "CAT II | RHEL-07-010190 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed the number of repeating characters of the same character class must not be more than four characters."
  block:
    - name: Check for password character class repeat requirement
      shell: |
        grep -qs "^maxclassrepeat = 4" /etc/security/pwquality.conf
      args:
        warn: false
      register: pwquality_class_repeat_check
      failed_when: pwquality_class_repeat_check.rc > 1
      changed_when: false
    - name: Correct pwquality character repeat requirement
      shell: |
        rule="maxclassrepeat"
        correct="4"
        if grep -qs "^${rule}" /etc/security/pwquality.conf; then
          sed -in "s/^${rule} = .*/${rule} = ${correct}/" /etc/security/pwquality.conf
        else
          echo "${rule} = ${correct}" >> /etc/security/pwquality.conf
        fi
      args:
        warn: false
      when:
        - (pwquality_class_repeat_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010190

- name: "CAT II | RHEL-07-010200 | The Red Hat Enterprise Linux operating system must be configured so that the PAM system service is configured to store only encrypted representations of passwords."
  block:
    - name: Check PAM to only store encrypted representations of passwords
      pamd:
        name: "{{ item[0] }}"
        state: "{{ item[1].state }}"
        type: password
        control: sufficient
        module_path: pam_unix.so
        module_arguments: "{{ item[1].args }}"
      with_nested:
        - [ 'system-auth', 'password-auth' ]
        -
          - state: args_present
            args:
              - "sha512"
          - state: args_absent
            args:
              - "md5"
              - "bigcrypt"
              - "sha256"
              - "blowfish"
  tags:
    - CAT-II
    - RHEL-07-010200

- name: "CAT II | RHEL-07-010210 | The Red Hat Enterprise Linux operating system must be configured to use the shadow file to store only encrypted representations of passwords."
  block:
    - name: Check shadow file to only store encrypted representations of passwords
      lineinfile:
        dest: /etc/login.defs
        regexp: ^#?ENCRYPT_METHOD
        line: "ENCRYPT_METHOD SHA512"
  tags:
    - CAT-II
    - RHEL-07-010210

- name: "CAT II | RHEL-07-010220 | The Red Hat Enterprise Linux operating system must be configured so that user and group account administration utilities are configured to store only encrypted representations of passwords."
  block:
    - name: Check libuser.conf to only store encrypted representations of passwords
      lineinfile:
        dest: /etc/libuser.conf
        regexp: ^#?crypt_style
        line: crypt_style = sha512
  tags:
    - CAT-II
    - RHEL-07-010220

- name: "CAT II | RHEL-07-010230 | The Red Hat Enterprise Linux operating system must be configured so that passwords for new users are restricted to a 24 hours/1 day minimum lifetime."
  block:
    - name: Check minimum password lifetime
      lineinfile:
        create: yes
        dest: /etc/login.defs
        regexp: ^#?PASS_MIN_DAYS
        line: "PASS_MIN_DAYS 1"
  tags:
    - CAT-II
    - RHEL-07-010230

- name: "CAT II | RHEL-07-010240 | The Red Hat Enterprise Linux operating system must be configured so that passwords are restricted to a 24 hours/1 day minimum lifetime."
  block:
    - name: Check minimum password lifetime for accounts
      command: "awk -F: '$1 !~ /^root$/ && $2 !~ /^[!*]/ && $4 < 1 {print $1}' /etc/shadow"
      check_mode: no
      changed_when: no
      register: minimum_password_life_check
    - name: Fix minimum password lifetime for accounts
      command: chage -m 1 {{ item }}
      with_items: "{{ minimum_password_life_check.stdout_lines }}"
  tags:
    - CAT-II
    - RHEL-07-010240

- name: "CAT II | RHEL-07-010250 | The Red Hat Enterprise Linux operating system must be configured so that passwords for new users are restricted to a 60-day maximum lifetime."
  block:
    - name: Check maximum password lifetime
      lineinfile:
        create: yes
        dest: /etc/login.defs
        regexp: ^#?PASS_MAX_DAYS
        line: "PASS_MAX_DAYS 60"
  tags:
    - CAT-II
    - RHEL-07-010250

- name: "CAT II | RHEL-07-010260 | The Red Hat Enterprise Linux operating system must be configured so that existing passwords are restricted to a 60-day maximum lifetime."
  block:
    - name: Check maximum password lifetime for accounts
      command: "awk -F: '$1 !~ /^root$/ && $2 !~ /^[!*]/ && $5 > 60 {print $1}' /etc/shadow"
      check_mode: no
      changed_when: maximum_password_life_check.stdout != ""
      register: maximum_password_life_check
    - name: Reset password to prevent locking users out
      command: chage -d '-1 day' {{ item }}
      with_items: "{{ maximum_password_life_check.stdout_lines }}"
    - name: Fix maximum password lifetime for accounts
      command: chage -M 60 {{ item }}
      with_items: "{{ maximum_password_life_check.stdout_lines }}"
  tags:
    - CAT-II
    - RHEL-07-010260

- name: "CAT II | RHEL-07-010270 | The Red Hat Enterprise Linux operating system must be configured so that passwords are prohibited from reuse for a minimum of five generations."
  block:
    - name: Ensure pam_pwhistory rule exists
      pamd:
        name: "{{ item }}"
        state: before
        type: password
        control: sufficient
        module_path: pam_unix.so
        new_type: password
        new_control: requisite
        new_module_path: pam_pwhistory.so
      with_items:
        - "system-auth"
        - "password-auth"
    - name: Check for existing password history reuse settings
      command: "grep -iE '^password\\s+requisite\\s+pam_pwhistory.so\\s+use_authtok\\s+remember=5\\s+retry=3$' /etc/pam.d/{{ item }}"
      check_mode: no
      changed_when: no
      failed_when: password_history_check.rc > 1
      register: password_history_check
      with_items:
        - "system-auth"
        - "password-auth"
    - name: Fix password history reuse settings
      pamd:
        name: "{{ item.item }}"
        state: updated
        type: password
        control: requisite
        module_path: pam_pwhistory.so
        module_arguments:
          - use_authtok
          - remember=5
          - retry=3
      with_items: "{{ password_history_check.results }}"
      when: item.rc == 1
  tags:
    - CAT-II
    - RHEL-07-010270

- name: "CAT II | RHEL-07-010280 | The Red Hat Enterprise Linux operating system must be configured so that passwords are a minimum of 15 characters in length."
  block:
    - name: check and fix pwquality minimum password length
      lineinfile:
        create: yes
        dest: /etc/security/pwquality.conf
        regexp: '^#?\s*minlen'
        line: "minlen = 15"
  tags:
    - CAT-II
    - RHEL-07-010280

- name: "CAT I | RHEL-07-010290 | The Red Hat Enterprise Linux operating system must not have accounts configured with blank or null passwords."
  block:
    - name: check for the possibility of null or blank passwords
      replace:
        dest: "{{ item }}"
        follow: true
        regexp: 'nullok ?'
      with_items:
        - /etc/pam.d/system-auth
        - /etc/pam.d/password-auth
  tags:
    - CAT-I
    - RHEL-07-010290

- name: "CAT I | RHEL-07-010300 | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon does not allow authentication using an empty password."
  block:
    - name: check for the possibility ssh with null or blank passwords
      lineinfile:
        state: present
        dest: /etc/ssh/sshd_config
        regexp: "(?i)^#?PermitEmptyPasswords"
        line: PermitEmptyPasswords no
        validate: /usr/sbin/sshd -tf %s
      notify: restart sshd
  tags:
    - CAT-I
    - RHEL-07-010300

- name: "CAT II | RHEL-07-010310 | The Red Hat Enterprise Linux operating system must disable account identifiers (individuals, groups, roles, and devices) if the password expires."
  block:
    - name: check for inactivation of user after password expires
      lineinfile:
        dest: /etc/default/useradd
        regexp: ^#?INACTIVE
        line: INACTIVE=0
  tags:
    - CAT-II
    - RHEL-07-010310

- name: |
    "CAT II | RHEL-07-010320 | The Red Hat Enterprise Linux operating system must be configured to lock accounts for a minimum of 15 minutes after three unsuccessful logon attempts within a 15-minute timeframe."
    "CAT II | RHEL-07-010330 | The Red Hat Enterprise Linux operating system must lock the associated account after three unsuccessful root logon attempts are made within a 15-minute period."
  block:
    - name: verify pam_faillock.so module exists
      pamd:
        name: "{{ item }}"
        state: before
        type: auth
        control: sufficient
        module_path: pam_unix.so
        new_type: auth
        new_control: required
        new_module_path: pam_faillock.so
      with_items:
        - "system-auth"
        - "password-auth"
    - name: check if correct rules are set for locking after 3 unsuccessful password attempts
      command: "grep -iE '^auth\\s+required\\s+pam_faillock.so\\s+preauth\\s+silent\\s+audit\\s+deny=3\\s+even_deny_root\\s+fail_interval=900\\s+unlock_time=900$' /etc/pam.d/{{ item }}"
      check_mode: no
      changed_when: no
      failed_when: password_lock_rules_check.rc > 1
      register: password_lock_rules_check
      with_items:
        - "system-auth"
        - "password-auth"
    - name: set correct rules for locking
      pamd:
        name: "{{ item.item }}"
        state: updated
        type: auth
        control: required
        module_path: pam_faillock.so
        module_arguments: "preauth silent audit deny=3 even_deny_root fail_interval=900 unlock_time=900"
      with_items: "{{ password_lock_rules_check.results }}"
      when: item.rc == 1
    - name: add default die to faillock
      pamd:
        name: "{{ item }}"
        state: before
        type: auth
        control: required
        module_path: pam_deny.so
        new_type: auth
        new_control: "[default=die]"
        new_module_path: pam_faillock.so
      with_items:
        - "system-auth"
        - "password-auth"
    - name: check if correct rules are set for authfail
      command: "grep -iE '^auth\\s+\\[default=die\\]\\s+pam_faillock.so\\s+authfail\\s+audit\\s+deny=3\\s+even_deny_root\\s+fail_interval=900\\s+unlock_time=900$' /etc/pam.d/{{ item }}"
      check_mode: no
      changed_when: no
      failed_when: authfail_check.rc > 1
      register: authfail_check
      with_items:
        - "system-auth"
        - "password-auth"
    - name: set correct rules for authfail
      pamd:
        name: "{{ item.item }}"
        state: updated
        type: auth
        control: "[default=die]"
        module_path: pam_faillock.so
        module_arguments: "authfail audit deny=3 even_deny_root fail_interval=900 unlock_time=900"
      with_items: "{{ authfail_check.results }}"
      when: item.rc == 1
    - name: make sure faillock module is required
      pamd:
        name: "{{ item }}"
        state: before
        type: account
        control: required
        module_path: pam_unix.so
        new_type: account
        new_control: required
        new_module_path: pam_faillock.so
      with_items:
        - "system-auth"
        - "password-auth"
  tags:
    - CAT-II
    - RHEL-07-010320
    - RHEL-07-010330

- name: "CAT II | RHEL-07-010340 | The Red Hat Enterprise Linux operating system must be configured so that users must provide a password for privilege escalation."
  block:
    - name: verify that password is needed for privilege escalation
      replace:
        path: "{{ item }}"
        regexp: '^([^#].*)NOPASSWD(.*)'
        replace: '\1PASSWD\2'
        validate: '/usr/sbin/visudo -cf %s'
      with_items: "{{ sudoers_files.stdout_lines }}"
  tags:
    - CAT-II
    - RHEL-07-010340

- name: "CAT II | RHEL-07-010350 | The Red Hat Enterprise Linux operating system must be configured so that users must re-authenticate for privilege escalation."
  block:
    - name: verify that reauthentication is needed for privilege escalation
      replace:
        path: "{{ item }}"
        regexp: '^([^#].*)!authenticate(.*)'
        replace: '\1authenticate\2'
        validate: '/usr/sbin/visudo -cf %s'
      with_items: "{{ sudoers_files.stdout_lines }}"
  tags:
    - CAT-II
    - RHEL-07-010350

- name: "CAT II | RHEL-07-010430 | The Red Hat Enterprise Linux operating system must be configured so that the delay between logon prompts following a failed console logon attempt is at least four seconds."
  block:
    - name: verify login delay on failed password
      lineinfile:
        dest: /etc/login.defs
        regexp: ^#?FAIL_DELAY
        line: "FAIL_DELAY 4"
  tags:
    - CAT-II
    - RHEL-07-010430

- name: "CAT I | RHEL-07-010440 | The Red Hat Enterprise Linux operating system must not allow an unattended or automatic logon to the system via a graphical user interface."
  block:
    - name: don't allow unattended graphical login
      lineinfile:
        dest: /etc/gdm/custom.conf
        regexp: (?i)automaticloginenable
        line: AutomaticLoginEnable=false
        insertafter: '\[daemon\]'
  tags:
    - CAT-I
    - RHEL-07-010440

- name: "CAT I | RHEL-07-010450 | The Red Hat Enterprise Linux operating system must not allow an unrestricted logon to the system."
  block:
    - name: don't allow unrestricted logon
      lineinfile:
        dest: /etc/gdm/custom.conf
        regexp: (?i)timedloginenable
        line: TimedLoginEnable=false
        insertafter: '\[daemon\]'
  tags:
    - CAT-I
    - RHEL-07-010450

- name: "CAT II | RHEL-07-010460 | The Red Hat Enterprise Linux operating system must not allow users to override SSH environment variables."
  block:
    - name: don't allow users to override ssh env variables
      lineinfile:
        dest: /etc/ssh/sshd_config
        regexp: "(?i)^#?PermitUserEnvironment"
        line: PermitUserEnvironment no
        validate: /usr/sbin/sshd -t -f %s
      notify: restart sshd
  tags:
    - CAT-II
    - RHEL-07-010460

- name: "CAT II | RHEL-07-010470 | The Red Hat Enterprise Linux operating system must not allow a non-certificate trusted host SSH logon to the system."
  block:
    - name: don't allow users to ssh with non-certificate trusted logon
      lineinfile:
        dest: /etc/ssh/sshd_config
        regexp: "(?i)^#?HostbasedAuthentication"
        line: HostbasedAuthentication no
        validate: /usr/sbin/sshd -t -f %s
      notify: restart sshd
  tags:
    - CAT-II
    - RHEL-07-010470

- name: |
    "CAT I | RHEL-07-010480 | Red Hat Enterprise Linux operating systems prior to version 7.2 with a Basic Input/Output System (BIOS) must require authentication upon booting into single-user and maintenance modes."
    "CAT I | RHEL-07-010482 | Red Hat Enterprise Linux operating systems version 7.2 or newer with a Basic Input/Output System (BIOS) must require authentication upon booting into single-user and maintenance modes."
    "CAT I | RHEL-07-010490 | Red Hat Enterprise Linux operating systems prior to version 7.2 using Unified Extensible Firmware Interface (UEFI) must require authentication upon booting into single-user and maintenance modes."
  block:
    - debug:
        msg:
          - "This is not applicable for UEFI Systems"
          - "This is not applicable for RHEL >7.2"
  tags:
    - CAT-I
    - RHEL-07-010480
    - RHEL-07-010482
    - RHEL-07-010490

- name: "CAT II | RHEL-07-010481 | The Red Hat Enterprise Linux operating system must require authentication upon booting into single-user and maintenance modes."
  block:
    - name: make sure authentication is required for singled-user mode
      lineinfile:
        create: true
        dest: /usr/lib/systemd/system/rescue.service
        regexp: ^#?ExecStart=
        line: ExecStart=-/bin/sh -c "/usr/sbin/sulogin; /usr/bin/systemctl --fail --no-block default"
  tags:
    - CAT-II
    - RHEL-07-010481

- name: "CAT I | RHEL-07-010491 | Red Hat Enterprise Linux operating systems version 7.2 or newer using Unified Extensible Firmware Interface (UEFI) must require authentication upon booting into single-user and maintenance modes."
  block:
    - name: verify bootloader authentication password
      lineinfile:
        path: /boot/efi/EFI/redhat/user.cfg
        create: yes
        regexp: ^GRUB2_PASSWORD=
        line: GRUB2_PASSWORD={{ bootloader_password_hash }}
      notify: make grub2 config
    - name: verify superuser accounts for bootloader
      lineinfile:
        dest: /boot/efi/EFI/redhat/grub.cfg
        create: yes
        insertafter: EOF
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      notify: make grub2 config
      with_items:
        - regexp: ^\s*set superusers=
          line: '    set superusers="root"'
        - regexp: ^\s*export superusers
          line: '    export superusers'
  tags:
    - CAT-I
    - RHEL-07-010491

- name: "CAT I | RHEL-07-020000 | The Red Hat Enterprise Linux operating system must not have the rsh-server package installed."
  block:
    - name: make sure rsh-server is not installed
      yum:
        name: rsh-server
        state: absent
  tags:
    - CAT-I
    - RHEL-07-020000

- name: "CAT I | RHEL-07-020010 | The Red Hat Enterprise Linux operating system must not have the ypserv package installed."
  block:
    - name: make sure ypserv is not installed
      yum:
        name: ypserv
        state: absent
  tags:
    - CAT-I
    - RHEL-07-020010

#- name: "CAT II | RHEL-07-020020 | The Red Hat Enterprise Linux operating system must prevent non-privileged users from executing privileged functions to include disabling, circumventing, or altering implemented security safeguards/countermeasures."
#  block:
#    - name: check authorized users
#      command: "true"
#      changed_when: no
#      when: rhel_07_020020
#      tags:
#          - CAT-II
#          - RHEL-07-020020
#   Might need to be done manually

- name: |
    "CAT II | RHEL-07-020030 | The Red Hat Enterprise Linux operating system must be configured so that a file integrity tool verifies the baseline operating system configuration at least weekly."
    "CAT II | RHEL-07-020040 | The Red Hat Enterprise Linux operating system must be configured so that designated personnel are notified if baseline configurations are changed in an unauthorized manner."
  block:
    - name: ensure aide installed
      command: rpm -q aide
      args:
        warn: false
      register: aide_installed
      failed_when: aide_installed.rc == 1
      changed_when: false

    - name: ensure /etc/cron.daily/aide exists
      stat:
        path: /etc/cron.daily/aide
      register: aide_cron_daily

    - name: create  /etc/cron.daily/aide if it does not exist
      file:
        path: /etc/cron.daily/aide
        state: touch
        owner: root
        group: root
        mode: 0600
        #create: yes
      when: aide_cron_daily.stat.exists == false

    - name: ensure /etc/cron.daily/aide is set correctly
      lineinfile:
        path: /etc/cron.daily/aide
        line: '{{ item }}'
      with_items:
        - '#!/bin/bash'
        - '/usr/sbin/aide --check | /bin/mail -s "$HOSTNAME - Daily aide integrity check run" root'
      when: aide_installed.rc == 0
  tags:
    - CAT-II
    - RHEL-07-020030
    - RHEL-07-020040

- name: "CAT I | RHEL-07-020050 | The Red Hat Enterprise Linux operating system must prevent the installation of software, patches, service packs, device drivers, or operating system components from a repository without verification they have been digitally signed using a certificate that is issued by a Certificate Authority (CA) that is recognized and approved by the organization."
  block:
    - name: "set yum to verify the signature of packages"
      lineinfile:
        dest: /etc/yum.conf
        regexp: ^gpgcheck
        line: gpgcheck=1
        insertafter: '\[main\]'
  tags:
    - CAT-I
    - RHEL-07-020050

- name: "CAT I | RHEL-07-020060 | The Red Hat Enterprise Linux operating system must prevent the installation of software, patches, service packs, device drivers, or operating system components of local packages without verification they have been digitally signed using a certificate that is issued by a Certificate Authority (CA) that is recognized and approved by the organization."
  block:
    - name: verify all packages verify gpg keys
      lineinfile:
        dest: /etc/yum.conf
        regexp: ^localpkg_gpgcheck
        line: localpkg_gpgcheck=1
        insertafter: '\[main\]'
  tags:
    - CAT-I
    - RHEL-07-020060

- name: "CAT II | RHEL-07-020100 | The Red Hat Enterprise Linux operating system must be configured to disable USB mass storage."
  block:
    - name: verify usb storage is disabled
      lineinfile:
        dest: /etc/modprobe.d/usb-storage.conf
        insertafter: "{{ item.insertafter }}"
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        create: yes
        owner: root
        group: root
        mode: "0644"
      with_items:
        - insertafter: "^#blacklist usb-storage(\\s+|$)"
          regexp: "^blacklist usb-storage(\\s+|$)"
          line: 'blacklist usb-storage'
        - insertafter: "^#install usb-storage"
          regexp: "^install usb-storage"
          line: install usb-storage /bin/true
  tags:
    - CAT-II
    - RHEL-07-020100

- name: "CAT II | RHEL-07-020101 | The Red Hat Enterprise Linux operating system must be configured so that the Datagram Congestion Control Protocol (DCCP) kernel module is disabled unless required."
  block:
    - name: verify dccp is disabled
      lineinfile:
        dest: /etc/modprobe.d/dccp.conf
        insertafter: "{{ item.insertafter }}"
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        create: yes
        owner: root
        group: root
        mode: "0644"
      with_items:
        - insertafter: ^#blacklist dccp
          regexp: ^blacklist dccp(\s+|$)
          line: blacklist dccp
        - insertafter: ^#install dccp
          regexp: "^install dccp "
          line: install dccp /bin/true
  tags:
    - CAT-II
    - RHEL-07-020101

- name: "CAT II | RHEL-07-020110 | The Red Hat Enterprise Linux operating system must disable the file system automounter unless required."
  block:
    - name: check if autofs exists
      shell: "systemctl show autofs | grep LoadState | cut -d = -f 2"
      register: autofs_service_check
      changed_when: no
      check_mode: no
    - name: verify autofs is disabled
      service:
        name: autofs
        enabled: no
        state: stopped
      when: autofs_service_check == "loaded"
  tags:
    - CAT-II
    - RHEL-07-020110

- name: "CAT III | RHEL-07-020200 | The Red Hat Enterprise Linux operating system must remove all software components after updated versions have been installed."
  block:
    - name: check if yum cleans components after updating
      lineinfile:
        dest: /etc/yum.conf
        regexp: ^#?clean_requirements_on_remove
        line: clean_requirements_on_remove=1
        insertafter: '\[main\]'
  tags:
    - CAT-III
    - RHEL-07-020200

- name: |
    "CAT I | RHEL-07-020210 | The Red Hat Enterprise Linux operating system must enable SELinux."
    "CAT I | RHEL-07-020220 | The Red Hat Enterprise Linux operating system must enable the SELinux targeted policy."
  block:
    - name: check if SELinux is enforcing
      selinux:
        state: enforcing
        policy: targeted
  tags:
    - CAT-I
    - RHEL-07-020210
    - RHEL-07-020220

- name: "CAT I | RHEL-07-020230 | The Red Hat Enterprise Linux operating system must be configured so that the x86 Ctrl-Alt-Delete key sequence is disabled on the command line."
  block:
    - name: mask ctrl-alt-delete
      command: systemctl mask ctrl-alt-del.target
      args:
        warn: false
  tags:
    - CAT-I
    - RHEL-07-020230

- name: "CAT I | RHEL-07-020231 | The Red Hat Enterprise Linux operating system must be configured so that the x86 Ctrl-Alt-Delete key sequence is disabled in the GUI."
  block:
    - name: create /etc/dconf/db/local.d/00-disable-CAD
      file:
        path: /etc/dconf/db/local.d/00-disable-CAD
        state: touch
        owner: root
        group: root

    - name: disable ctrl-alt-delete for GUI
      copy:
        dest: /etc/dconf/db/local.d/00-disable-CAD
        content: |
          [org/gnome/settings-daemon/plugins/media-keys]
          logout=''
        mode: '0644'
      notify: dconf update
  tags:
    - CAT-I
    - RHEL-07-020231

- name: "CAT II | RHEL-07-020240 | The Red Hat Enterprise Linux operating system must define default permissions for all authenticated users in such a way that the user can only read and modify their own files."
  block:
    - name: make sure users can only read and modify their own files
      lineinfile:
        dest: /etc/login.defs
        regexp: ^#?UMASK
        line: "UMASK 077"
  tags:
    - CAT-II
    - RHEL-07-020240

- name: "CAT II | RHEL-07-020610 | The Red Hat Enterprise Linux operating system must be configured so that all local interactive user accounts, upon creation, are assigned a home directory."
  block:
    - name: make all new users are assigned a home directory
      lineinfile:
        dest: /etc/login.defs
        regexp: ^#?CREATE_HOME
        line: "CREATE_HOME yes"
  tags:
    - CAT-II
    - RHEL-07-020610


- name: "CAT II | RHEL-07-021100 | The Red Hat Enterprise Linux operating system must have cron logging implemented."
  lineinfile:
    path: /etc/rsyslog.conf
    state: present
    regexp: '^cron\.\*[ \t]+/var/log/cron$'
    line: 'cron.*                                                  /var/log/cron'
    insertafter: '#### RULES ####'
  #register: result
  #failed_when:
  #  - result is failed
  #  - result.rc != 257
  tags:
    - CAT-II
    - RHEL-07-021100

- name: "CAT II | RHEL-07-021110 | The Red Hat Enterprise Linux operating system must be configured so that the cron.allow file, if it exists, is owned by root."
  block:
    - name: "check for cron.allow"
      stat:
        path: /etc/cron.allow
      register: cron_allow

    - name: "set the persmissions, ownership, and group of cron.allow"
      file:
        dest: /etc/cron.allow
        state: file
        owner: root
        group: root
        mode: 0600
      when: cron_allow.stat.exists == true
  tags:
    - CAT-II
    - RHEL-07-021110
    - RHEL-07-021120

- name: "CAT II| RHEL-07-021300 | The Red Hat Enterprise Linux operating system must disable Kernel core dumps unless needed."
  block:
    - name: "Register status of kdump"
      shell: "systemctl show kdump | grep LoadState | cut -d = -f 2"
      register: rhel_07_021300_kdump_service_status
      #changed_when: no
      #check_mode: no

    - name: "Disable kdump if it's loaded"
      service:
          name: kdump
          enabled: no
          state: stopped
      when: rhel_07_021300_kdump_service_status.stdout == "loaded"
  tags:
    - CAT-II
    - RHEL-07-021300

- name: "CAT I | RHEL-07-021710 |The Red Hat Enterprise Linux operating system must not have the telnet-server package installed "
  yum:
    name: telnet-server
    state: absent
  tags:
    - CAT-I
    - RHEL-07-021710

# - name: "CAT I | RHEL-07-030000 | The Red Hat Enterprise Linux operating system must be configured so that auditing is configured to produce records containing information to establish what type of events occurred, where the events occurred, the source of the events, and the outcome of the events. These audit records must also identify individual identities of group account users."
#   block:
#     - name: "ensure auditd is present"
#       yum:
#         name: audit
#         state: present

#     - name: "ensure auditd is enable and started"
#       service:
#         name: auditd
#         state: started
#         enabled: yes
#   tags:
#     - CAT-I
#     - RHEL-07-030000

## 030010-030920	Audit stuff

- name: "CAT II | RHEL-07-030010 |  The Red Hat Enterprise Linux operating system must shut down upon audit processing failure, unless availability is an overriding concern. If availability is a concern, the system must alert the designated staff (System Administrator [SA] and Information System Security Officer [ISSO] at a minimum) in the event of an audit processing failure."
  command: auditctl -f 2

- name: "CAT II | RHEL-07-030200 | The Red Hat Enterprise Linux operating system must be configured to use the au-remote plugin."
  block:
    - name: "Check for  au-remote"
      stat:
        path: /etc/audisp/plugins.d/au-remote.conf
      register: au_remote_status
    - name: "Create au-remote.conf"
      file:
        path: /etc/audisp/plugins.d/au-remote.conf
        state: touch
      when: au_remote_status.stat.exists == false

- name: |
    "CAT II | RHEL-07-030201 | The Red Hat Enterprise Linux operating system must configure the au-remote plugin to off-load audit logs using the audisp-remote daemon."
    "CAT II | RHEL-07-030210 | The Red Hat Enterprise Linux operating system must take appropriate action when the audisp-remote buffer is full."
    "CAT II | RHEL-07-030211 | The Red Hat Enterprise Linux operating system must label all off-loaded audit logs before sending them to the central log server."
  block:
    - name: "regiester existence of au-remote.cont"
      stat:
        path: /etc/audisp/plugins.d/au-remote.conf
      register: au_remote_change
    - name: "Configure audispd.conf"
      lineinfile:
        path: /etc/audisp/plugins.d/au-remote.conf
        line: '{{ item }}'
      with_items:
        - 'active = yes'
        - 'direction = out'
        - 'path = /sbin/audisp-remote'
        - 'type = always'
        - 'overflow_action = syslog'
        - 'name_format = hostname'
      when: au_remote_status.stat.exists
      tags:
        - CAT-II
        - RHEL-07-030201
        - RHEL-07-030210

- name: "CAT-II | RHEL-07-030310 | The Red Hat Enterprise Linux operating system must encrypt the transfer of audit records off-loaded onto a different system or media from the system being audited."
  block:
    - name: "create /etc/audisp/audisp-remote.conf"
      file:
        dest: /etc/audisp/audisp-remote.conf
        state: touch
        owner: root
        group: root
        mode: 0600

    - name: "set krb5 status"
      lineinfile:
        path: /etc/audisp/audisp-remote.conf
        regexp: ^enable_krb5 +=
        line: enable_krb5 = yes
  tags:
      - CAT-II
      - RHEL-07-030310

- name: "CAT-II | RHEL-07-030320 | The Red Hat Enterprise Linux operating system must be configured so that the audit system takes appropriate action when the audit storage volume is full."
  lineinfile:
      path: /etc/audisp/audisp-remote.conf
      regexp: ^disk_full_action +=
      line: "disk_full_action = single"
  tags:
      - CAT-II
      - RHEL-07-030320

- name: "CAT-II | RHEL-07-030321 | The Red Hat Enterprise Linux operating system must be configured so that the audit system takes appropriate action when there is an error sending audit records to a remote system."
  lineinfile:
      path: /etc/audisp/audisp-remote.conf
      regexp: ^network_failure_action +=
      line: "network_failure_action = syslog"
  tags:
      - CAT-II
      - RHEL-07-030321

- name: "CAT-II | RHEL-07-030340 | The Red Hat Enterprise Linux operating system must immediately notify the System Administrator (SA) and Information System Security Officer (ISSO) (at a minimum) via email when the threshold for the repository maximum audit record storage capacity is reached."
  lineinfile:
      path: /etc/audit/auditd.conf
      regexp: ^space_left_action +=
      line: "space_left_action = email"
  tags:
      - CAT-II
      - RHEL-07-030340

- name: "CAT-II| RHEL-07-030350 | The Red Hat Enterprise Linux operating system must immediately notify the System Administrator (SA) and Information System Security Officer (ISSO) (at a minimum) when the threshold for the repository maximum audit record storage capacity is reached."
  lineinfile:
      path: /etc/audit/auditd.conf
      regexp: ^action_mail_acct +=
      line: "action_mail_acct = root"
  tags:
      - CAT-II
      - RHEL-07-030350

- name: "CAT II | RHEL-07-030360 | The Red Hat Enterprise Linux operating system must audit all executions of privileged functions."
  block:
    - name: "Create an Audit config file to house all the DISA STIG RULES"
      file:
        path: /etc/audit/rules.d/DISA-STIGs.rules
        state: touch
        owner: root
        group: root
        mode: '0644'
    - name: RHEL-07-030360
      lineinfile:
        path: /etc/audit/rules.d/DISA-STIGs.rules
        line: '{{ item }}'
      with_items:
        -  '-a always,exit -F arch=b32 -S execve -C uid!=euid -F euid=0 -k setuid'
        -  '-a always,exit -F arch=b64 -S execve -C uid!=euid -F euid=0 -k setuid'
        -  '-a always,exit -F arch=b32 -S execve -C gid!=egid -F egid=0 -k setgid'
        -  '-a always,exit -F arch=b64 -S execve -C gid!=egid -F egid=0 -k setgid'
  tags:
    - CAT-II
    - RHEL-07-030360

- name: "CAT II | RHEL-07-030370 | The Red Hat Enterprise Linux operating system must audit all uses of the chown syscall"
  # Chown usage
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S chown -F auid>=1000 -F auid!=4294967295 -k perm_mod'
    -  '-a always,exit -F arch=b64 -S chown -F auid>=1000 -F auid!=4294967295 -k perm_mod'
  tags:
    - CAT-II
    - RHEL-07-030370

- name: "CAT II | RHEL-07-030380 | The Red Hat Enterprise Linux operating system must audit all uses of the fchown syscall."
  # fChown usage
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S fchown -F auid>=1000 -F auid!=4294967295 -k perm_mod'
    -  '-a always,exit -F arch=b64 -S fchown -F auid>=1000 -F auid!=4294967295 -k perm_mod'
  tags:
    - CAT-II
    - RHEL-07-030380

- name: " CAT II | RHEL-07-030390 | The Red Hat Enterprise Linux operating system must audit all uses of the lchown syscall"
  # lChown usage
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S lchown -F auid>=1000 -F auid!=4294967295 -k perm_mod'
    -  '-a always,exit -F arch=b64 -S lchown -F auid>=1000 -F auid!=4294967295 -k perm_mod'
  tags:
    - CAT-II
    - RHEL-07-030390

- name: " CAT II | RHEL-07-030400 | The Red Hat Enterprise Linux operating system must audit all uses of the fchownat syscall."
  # fChownat usage
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S fchownat -F auid>=1000 -F auid!=4294967295 -k perm_mod'
    -  '-a always,exit -F arch=b64 -S fchownat -F auid>=1000 -F auid!=4294967295 -k perm_mod'
  tags:
    - CAT-II
    - RHEL-07-030400

- name: " CAT II | RHEL-07-030410 | The Red Hat Enterprise Linux operating system must audit all uses of the chmod syscall."
  # chmod usage
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S chmod -F auid>=1000 -F auid!=4294967295 -k perm_mod'
    -  '-a always,exit -F arch=b64 -S chmod -F auid>=1000 -F auid!=4294967295 -k perm_mod'
  tags:
    - CAT-II
    - RHEL-07-030410

- name: " CAT II | RHEL-07-030420 | The Red Hat Enterprise Linux operating system must audit all uses of the fchmod syscall."
  # fchmod usage
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S fchmod -F auid>=1000 -F auid!=4294967295 -k perm_mod'
    -  '-a always,exit -F arch=b64 -S fchmod -F auid>=1000 -F auid!=4294967295 -k perm_mod'
  tags:
    - CAT-II
    - RHEL-07-030420

- name: " CAT II | RHEL-07-030430 | The Red Hat Enterprise Linux operating system must audit all uses of the fchmodat syscall"
  # fchmodat usage
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S fchmodat -F auid>=1000 -F auid!=4294967295 -k perm_mod'
    -  '-a always,exit -F arch=b64 -S fchmodat -F auid>=1000 -F auid!=4294967295 -k perm_mod'
  tags:
    - CAT-II
    - RHEL-07-030430

- name: " CAT II | RHEL-07-030440 | The Red Hat Enterprise Linux operating system must audit all uses of the setxattr syscall."
  # setxattr usage
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S setxattr -F auid>=1000 -F auid!=4294967295 -k perm_mod'
    -  '-a always,exit -F arch=b64 -S setxattr -F auid>=1000 -F auid!=4294967295 -k perm_mod'
  tags:
    - CAT-II
    - RHEL-07-030440

- name: " CAT II | RHEL-07-030450 | The Red Hat Enterprise Linux operating system must audit all uses of the fsetxattr syscall."
# fsetxattr usage
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S fsetxattr -F auid>=1000 -F auid!=4294967295 -k perm_mod'
    -  '-a always,exit -F arch=b64 -S fsetxattr -F auid>=1000 -F auid!=4294967295 -k perm_mod'
  tags:
    - CAT-II
    - RHEL-07-030450

- name: " CAT II | RHEL-07-030460 | The Red Hat Enterprise Linux operating system must audit all uses of the lsetxattr syscall."
  # lsetxattr usage
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S lsetxattr -F auid>=1000 -F auid!=4294967295 -k perm_mod'
    -  '-a always,exit -F arch=b64 -S lsetxattr -F auid>=1000 -F auid!=4294967295 -k perm_mod'
  tags:
    - CAT-II
    - RHEL-07-030460

- name: " CAT II | RHEL-07-030470 | The Red Hat Enterprise Linux operating system must audit all uses of the removexattr syscall."
  # removexattr usage
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S removexattr -F auid>=1000 -F auid!=4294967295 -k perm_mod'
    -  '-a always,exit -F arch=b64 -S removexattr -F auid>=1000 -F auid!=4294967295 -k perm_mod'
  tags:
    - CAT-II
    - RHEL-07-030470

- name: " CAT II | RHEL-07-030480 | The Red Hat Enterprise Linux operating system must audit all uses of the fremovexattr syscall."
  # fremovexattr usage
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S fremovexattr -F auid>=1000 -F auid!=4294967295 -k perm_mod'
    -  '-a always,exit -F arch=b64 -S fremovexattr -F auid>=1000 -F auid!=4294967295 -k perm_mod'
  tags:
    - CAT-II
    - RHEL-07-030480

- name: " CAT II | RHEL-07-030490 | The Red Hat Enterprise Linux operating system must audit all uses of the lremovexattr syscall."
  # lremovexattr usage
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S lremovexattr -F auid>=1000 -F auid!=4294967295 -k perm_mod'
    -  '-a always,exit -F arch=b64 -S lremovexattr -F auid>=1000 -F auid!=4294967295 -k perm_mod'
  tags:
    - CAT-II
    - RHEL-07-030490

- name: " CAT II | RHEL-07-030500 | The Red Hat Enterprise Linux operating system must audit all uses of the creat syscall"  # successful and unsuccessful uses of creat syscall
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S creat -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access'
    -  '-a always,exit -F arch=b32 -S creat -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access'
    -  '-a always,exit -F arch=b64 -S creat -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access'
    -  '-a always,exit -F arch=b64 -S creat -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access'
  tags:
    - CAT-II
    - RHEL-07-030500

- name: " CAT II | RHEL-07-030510 | The Red Hat Enterprise Linux operating system must audit all uses of the open syscall."
  # successful and unsuccessful uses of open syscall
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S open -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access'
    -  '-a always,exit -F arch=b32 -S open -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access'
    -  '-a always,exit -F arch=b64 -S open -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access'
    -  '-a always,exit -F arch=b64 -S open -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access'
  tags:
    - CAT-II
    - RHEL-07-030510

- name: " CAT II | RHEL-07-030520 | The Red Hat Enterprise Linux operating system must audit all uses of the openat syscall."
  # successful and unsuccessful uses of openat syscall
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S openat -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access'
    -  '-a always,exit -F arch=b32 -S openat -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access'
    -  '-a always,exit -F arch=b64 -S openat -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access'
    -  '-a always,exit -F arch=b64 -S openat -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access'
  tags:
    - CAT-II
    - RHEL-07-030520

- name: " CAT II | RHEL-07-030530 | The Red Hat Enterprise Linux operating system must audit all uses of the open_by_handle_at syscall."
  # successful and unsuccessful uses of open_by_handle_at syscall
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S open_by_handle_at -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access'
    -  '-a always,exit -F arch=b32 -S open_by_handle_at -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access'
    -  '-a always,exit -F arch=b64 -S open_by_handle_at -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access'
    -  '-a always,exit -F arch=b64 -S open_by_handle_at -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access'
  tags:
    - CAT-II
    - RHEL-07-030530

- name: " CAT II | RHEL-07-030540 | The Red Hat Enterprise Linux operating system must audit all uses of the truncate syscall."
  # successful and unsuccessful uses of truncate syscall
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S truncate -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access'
    -  '-a always,exit -F arch=b32 -S truncate -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access'
    -  '-a always,exit -F arch=b64 -S truncate -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access'
    -  '-a always,exit -F arch=b64 -S truncate -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access'
  tags:
    - CAT-II
    - RHEL-07-030540

- name: " CAT II | RHEL-07-030550 | The Red Hat Enterprise Linux operating system must audit all uses of the ftruncate syscall."
  # successful and unsuccessful uses of ftruncate syscall
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access'
    -  '-a always,exit -F arch=b32 -S ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access'
    -  '-a always,exit -F arch=b64 -S ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access'
    -  '-a always,exit -F arch=b64 -S ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access'
  tags:
    - CAT-II
    - RHEL-07-030550

- name: " CAT II | RHEL-07-030560 | The Red Hat Enterprise Linux operating system must audit all uses of the semanage command."
  # successful and unsuccessful uses of semanage syscall
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F path=/usr/sbin/semanage -F auid>=1000 -F auid!=4294967295 -k privileged-priv_change'
  tags:
    - CAT-II
    - RHEL-07-030560

- name: " CAT II | RHEL-07-030570 | The Red Hat Enterprise Linux operating system must audit all uses of the setsebool command."
  # successful and unsuccessful uses of setsebool syscall
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F path=/usr/sbin/setsebool -F auid>=1000 -F auid!=4294967295 -k privileged-priv_change'
  tags:
    - CAT-II
    - RHEL-07-030570

- name: " CAT II | RHEL-07-030580 | The Red Hat Enterprise Linux operating system must audit all uses of the setfiles command."
  # successful and unsuccessful uses of chcon syscall
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F path=/usr/bin/chcon -F auid>=1000 -F auid!=4294967295 -k privileged-priv_change'
  tags:
    - CAT-II
    - RHEL-07-030580

- name: " CAT II | RHEL-07-030590 | The Red Hat Enterprise Linux operating system must audit all uses of the setfiles command."
  # successful and unsuccessful uses of setfiles syscall
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F path=/usr/sbin/setfiles -F auid>=1000 -F auid!=4294967295 -k privileged-priv_change'
  tags:
    - CAT-II
    - RHEL-07-030590

- name: " CAT II | RHEL-07-030610 | The Red Hat Enterprise Linux operating system must generate audit records for all unsuccessful account access events."
  # failed logins
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-w /var/run/faillock -p wa -k logins'
  tags:
    - CAT-II
    - RHEL-07-030610

- name: " CAT II | RHEL-07-030620 | The Red Hat Enterprise Linux operating system must generate audit records for all successful account access events."
  # successful logins
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-w /var/log/lastlog -p wa -k logins'
  tags:
    - CAT-II
    - RHEL-07-030620

- name: " CAT II | RHEL-07-030630 | The Red Hat Enterprise Linux operating system must audit all uses of the passwd command."
  #  successful and unsuccessful attempts to use the "passwd" command
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F path=/usr/bin/passwd -F auid>=1000 -F auid!=4294967295 -k privileged-passwd'
  tags:
    - CAT-II
    - RHEL-07-030630

- name: " CAT II | RHEL-07-030640 | The Red Hat Enterprise Linux operating system must audit all uses of the unix_chkpwd command."
  #  successful and unsuccessful attempts to use the unix_chkpwd command
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F path=/usr/sbin/unix_chkpwd -F auid>=1000 -F auid!=4294967295 -k privileged-passwd'
  tags:
    - CAT-II
    - RHEL-07-030640

- name: " CAT II | RHEL-07-030650 | The Red Hat Enterprise Linux operating system must audit all uses of the gpasswd command."
  #  successful and unsuccessful attempts to use the gpasswd command
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F path=/usr/bin/gpasswd -F auid>=1000 -F auid!=4294967295 -k privileged-passwd'
  tags:
    - CAT-II
    - RHEL-07-030650

- name: " CAT II | RHEL-07-030660 | The Red Hat Enterprise Linux operating system must audit all uses of the chage command."
  #  successful and unsuccessful attempts to use the chage command
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    - '-a always,exit -F path=/usr/bin/chage -F auid>=1000 -F auid!=4294967295 -k privileged-passwd'
  tags:
    - CAT-II
    - RHEL-07-030660

- name: " CAT II | RHEL-07-030670 | The Red Hat Enterprise Linux operating system must audit all uses of the userhelper command."
  #  successful and unsuccessful attempts to use the userhelper command
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F path=/usr/sbin/userhelper -F auid>=1000 -F auid!=4294967295 -k privileged-passwd'
  tags:
    - CAT-II
    - RHEL-07-030670

- name: " CAT II | RHEL-07-030680 | The Red Hat Enterprise Linux operating system must audit all uses of the su command."
  #  successful and unsuccessful attempts to use the su command
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F path=/usr/bin/su -F auid>=1000 -F auid!=4294967295 -k privileged-priv_change'
  tags:
    - CAT-II
    - RHEL-07-030680

- name: " CAT II | RHEL-07-030690 | The Red Hat Enterprise Linux operating system must audit all uses of the sudo command."
  #  successful and unsuccessful attempts to use the sudo command
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F path=/usr/bin/sudo -F auid>=1000 -F auid!=4294967295 -k privileged-priv_change'
  tags:
    - CAT-II
    - RHEL-07-030690

- name: " CAT II | RHEL-07-030700 | The Red Hat Enterprise Linux operating system must audit all uses of the sudoers file and all files in the /etc/sudoers.d/ directory."
  #  successful and unsuccessful attempts to access the sudoers file and directory
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-w /etc/sudoers -p wa -k privileged-actions'
    -  '-w /etc/sudoers.d/ -p wa -k privileged-actions'
  tags:
    - CAT-II
    - RHEL-07-030700

- name: " CAT II | RHEL-07-030710 | The Red Hat Enterprise Linux operating system must audit all uses of the newgrp command."
  #  successful and unsuccessful attempts to use the newgrp command
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F path=/usr/bin/newgrp -F auid>=1000 -F auid!=4294967295 -k privileged-priv_change'
  tags:
    - CAT-II
    - RHEL-07-030710

- name: " CAT II | RHEL-07-030720 | The Red Hat Enterprise Linux operating system must audit all uses of the chsh command."
  #  successful and unsuccessful attempts to use the chsh command
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F path=/usr/bin/chsh -F auid>=1000 -F auid!=4294967295 -k privileged-priv_change'
  tags:
    - CAT-II
    - RHEL-07-030720

- name: " CAT II | RHEL-07-030740 | The Red Hat Enterprise Linux operating system must audit all uses of the mount command and syscall."
  #  successful and unsuccessful attempts to use the mount commands and syscalls
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S mount -F auid>=1000 -F auid!=4294967295 -k privileged-mount'
    -  '-a always,exit -F arch=b64 -S mount -F auid>=1000 -F auid!=4294967295 -k privileged-mount'
    -  '-a always,exit -F path=/usr/bin/mount -F auid>=1000 -F auid!=4294967295 -k privileged-mount'
  tags:
    - CAT-II
    - RHEL-07-030740

- name: " CAT II | RHEL-07-030750 | The Red Hat Enterprise Linux operating system must audit all uses of the umount command."
  #  successful and unsuccessful attempts to use the umount command
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F path=/usr/bin/umount -F auid>=1000 -F auid!=4294967295 -k privileged-mount'
  tags:
    - CAT-II
    - RHEL-07-030750

- name: " CAT II | RHEL-07-030760 | The Red Hat Enterprise Linux operating system must audit all uses of the postdrop command."
  #  successful and unsuccessful attempts to use the postdrop command
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F path=/usr/sbin/postdrop -F auid>=1000 -F auid!=4294967295 -k privileged-postfix'
  tags:
    - CAT-II
    - RHEL-07-030760

- name: " CAT II | RHEL-07-030770 | The Red Hat Enterprise Linux operating system must audit all uses of the postqueue command."
     #  successful and unsuccessful attempts to use the postqueue command
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F path=/usr/sbin/postqueue -F auid>=1000 -F auid!=4294967295 -k privileged-postfix'
  tags:
    - CAT-II
    - RHEL-07-030770

- name: " CAT II | RHEL-07-030780 | The Red Hat Enterprise Linux operating system must audit all uses of the ssh-keysign command."
  #  successful and unsuccessful attempts to use the ssh-keysign command
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F path=/usr/libexec/openssh/ssh-keysign -F auid>=1000 -F auid!=4294967295 -k privileged-ssh'
  tags:
    - CAT-II
    - RHEL-07-030780

- name: " CAT II | RHEL-07-030800 | The Red Hat Enterprise Linux operating system must audit all uses of the crontab command."
  #  successful and unsuccessful attempts to use the crontab command
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F path=/usr/bin/crontab -F auid>=1000 -F auid!=4294967295 -k privileged-cron'
  tags:
    - CAT-II
    - RHEL-07-030800

- name: " CAT II | RHEL-07-030810 | The Red Hat Enterprise Linux operating system must audit all uses of the pam_timestamp_check command."
  #  successful and unsuccessful attempts to use the pam_timestamp_check command
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F path=/usr/sbin/pam_timestamp_check -F auid>=1000 -F auid!=4294967295 -k privileged-pam'
  tags:
    - CAT-II
    - RHEL-07-030810

- name: " CAT II | RHEL-07-030819 | The Red Hat Enterprise Linux operating system must audit all uses of the create_module syscall."
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S create_module -k module-change'
    -  '-a always,exit -F arch=b64 -S create_module -k module-change'
  tags:
    - CAT-II
    - RHEL-07-030819

- name: " CAT II | RHEL-07-030820 | The Red Hat Enterprise Linux operating system must audit all uses of the init_module syscall."
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S init_module -k module-change'
    -  '-a always,exit -F arch=b64 -S init_module -k module-change'
  tags:
    - CAT-II
    - RHEL-07-030820

- name: " CAT II | RHEL-07-030821 | The Red Hat Enterprise Linux operating system must audit all uses of the finit_module syscall."
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S finit_module -k module-change'
    -  '-a always,exit -F arch=b64 -S finit_module -k module-change'
  tags:
    - CAT-II
    - RHEL-07-030821

- name: " CAT II | RHEL-07-030830 | The Red Hat Enterprise Linux operating system must audit all uses of the delete_module syscall."
     #  successful and unsuccessful attempts to use the delete_module syscall occur
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S delete_module -k module-change'
    -  '-a always,exit -F arch=b64 -S delete_module -k module-change'
  tags:
    - CAT-II
    - RHEL-07-030830

- name: "CAT II | RHEL-07-030840 | The Red Hat Enterprise Linux operating system must audit all uses of the kmod command."
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-w /usr/bin/kmod -p x -F auid!=4294967295 -k module-change'
  tags:
    - CAT-II
    - RHEL-07-030840

- name: "CAT II | RHEL-07-030870 | The Red Hat Enterprise Linux operating system must generate audit records for all account creations, modifications, disabling, and termination events that affect /etc/passwd."
  # Configure the operating system to generate audit records for all account creations, modifications, disabling, and termination events that affect "/etc/passwd".
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-w /etc/passwd -p wa -k identity'
  tags:
    - CAT-II
    - RHEL-07-030870

- name: "CAT II | RHEL-07-030871 | The Red Hat Enterprise Linux operating system must generate audit records for all account creations, modifications, disabling, and termination events that affect /etc/group."
  # onfigure the operating system to generate audit records for all account creations, modifications, disabling, and termination events that affect "/etc/group".
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-w /etc/group -p wa -k identity'
  tags:
    - CAT-II
    - RHEL-07-030871

- name: "CAT II | RHEL-07-030872 | The Red Hat Enterprise Linux operating system must generate audit records for all account creations, modifications, disabling, and termination events that affect /etc/gshadow."
  # onfigure the operating system to generate audit records for all account creations, modifications, disabling, and termination events that affect "/etc/gshadow".
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-w /etc/gshadow -p wa -k identity'
  tags:
    - CAT-II
    - RHEL-07-030872

- name: "CAT II | RHEL-07-030873 | The Red Hat Enterprise Linux operating system must generate audit records for all account creations, modifications, disabling, and termination events that affect /etc/shadow."
  # onfigure the operating system to generate audit records for all account creations, modifications, disabling, and termination events that affect "/etc/shadow".
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-w /etc/shadow -p wa -k identity'
  tags:
    - CAT-II
    - RHEL-07-030873

- name: "CAT II | RHEL-07-030874 |The Red Hat Enterprise Linux operating system must generate audit records for all account creations, modifications, disabling, and termination events that affect /etc/opasswd."
  # onfigure the operating system to generate audit records for all account creations, modifications, disabling, and termination events that affect "/etc/opasswd".
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-w /etc/security/opasswd -p wa -k identity'
  tags:
    - CAT-II
    - RHEL-07-030874

- name: "CAT II | RHEL-07-030880 | The Red Hat Enterprise Linux operating system must audit all uses of the rename syscall."
  #  successful and unsuccessful attempts to use the rename syscall occur
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
   -  '-a always,exit -F arch=b32 -S rename -F auid>=1000 -F auid!=4294967295 -k delete'
   -  '-a always,exit -F arch=b64 -S rename -F auid>=1000 -F auid!=4294967295 -k delete'
  tags:
    - CAT-II
    - RHEL-07-030880

- name: "CAT II | RHEL-07-030890 | The Red Hat Enterprise Linux operating system must audit all uses of the renameat syscall"
  #  successful and unsuccessful attempts to use the renameat syscall occur
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S renameat -F auid>=1000 -F auid!=4294967295 -k delete'
    -  '-a always,exit -F arch=b64 -S renameat -F auid>=1000 -F auid!=4294967295 -k delete'
  tags:
    - CAT-II
    - RHEL-07-030890

- name: "CAT II | RHEL-07-030900 | The Red Hat Enterprise Linux operating system must audit all uses of the rmdir syscall."
 #  successful and unsuccessful attempts to use the rmdir syscall occur
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S rmdir -F auid>=1000 -F auid!=4294967295 -k delete'
    -  '-a always,exit -F arch=b64 -S rmdir -F auid>=1000 -F auid!=4294967295 -k delete'
  tags:
    - CAT-II
    - RHEL-07-030900

- name: "CAT II | RHEL-07-030910 | The Red Hat Enterprise Linux operating system must audit all uses of the unlink syscall."
  #  successful and unsuccessful attempts to use the unlink syscall occur
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S unlink -F auid>=1000 -F auid!=4294967295 -k delete'
    -  '-a always,exit -F arch=b64 -S unlink -F auid>=1000 -F auid!=4294967295 -k delete'
  tags:
    - CAT-II
    - RHEL-07-030910

- name: "CAT II | RHEL-07-030920 |  The Red Hat Enterprise Linux operating system must audit all uses of the unlinkat syscall."
  #  successful and unsuccessful attempts to use the unlinkatsyscall occur
  lineinfile:
    path: /etc/audit/rules.d/DISA-STIGs.rules
    line: '{{ item }}'
  with_items:
    -  '-a always,exit -F arch=b32 -S unlinkat -F auid>=1000 -F auid!=4294967295 -k delete'
    -  '-a always,exit -F arch=b64 -S unlinkat -F auid>=1000 -F auid!=4294967295 -k delete'
  tags:
    - CAT-II
    - RHEL-07-030920

- name: load all the rules into the main audit rules file
  shell: /usr/sbin/augenrules --load
  register: command_result
  failed_when: "'FAILED' in command_result.stderr"


  ##031000 and  RHEL-07-031010 pull from logging.yml may need to be manual depending on loggin solution


- name: "CAT III| RHEL-07-040000 | The Red Hat Enterprise Linux operating system must limit the number of concurrent sessions to 10 for all accounts and/or account types."
  lineinfile:
    state: present
    dest: /etc/security/limits.conf
    insertbefore: '^# End of file'
    regexp: '^\*.*maxlogins'
    line: '*               hard    maxlogins       10'
  tags:
    - CAT-III
    - RHEL-07-040000

- name: "CAT II | RHEL-07-040110 | The Red Hat Enterprise Linux operating system must use a FIPS 140-2 approved cryptographic algorithm for SSH communications."
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "(?i)^#?Ciphers"
    line: Ciphers aes128-ctr,aes192-ctr,aes256-ctr
    validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  tags:
    - CAT-II
    - RHEL-07-040110

- name: "CAT II | RHEL-07-040160 | The Red Hat Enterprise Linux operating system must be configured so that all network connections associated with a communication session are terminated at the end of the session or after 10 minutes of inactivity from the user at a command prompt, except to fulfill documented and validated mission requirements."
  block:
    - name: "create the file"
      file:
        dest: /etc/profile.d/tmout.sh
        state: touch
        owner: root
        group: root
        mode: 0600

    - name: "append the file"
      blockinfile:
        path: /etc/profile.d/tmout.sh
        block: |
          #!/bin/bash
          TMOUT=600
          readonly TMOUT
          export TMOUT
  tags:
    - CAT-II
    - RHEL-07-040160

- name: "CAT II | RHEL-07-040170 | The Red Hat Enterprise Linux operating system must display the Standard Mandatory DoD Notice and Consent Banner immediately prior to, or as part of, remote access logon prompts."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?Banner"
      line: Banner /etc/issue
      validate: /usr/sbin/sshd -tf %s
  notify: restart sshd
  tags:
      - RHEL-07-040170
      - CAT-II


- name: "CAT II | RHEL-07-040201 | The Red Hat Enterprise Linux operating system must implement virtual address space randomization."
  sysctl:
      name: kernel.randomize_va_space
      value: 2
      state: present
      reload: yes
      sysctl_set: yes
      ignoreerrors: yes
  tags:
      - RHEL-07-040201
      - CAT-II

# - name: "CAT II | RHEL-07-040300 | The Red Hat Enterprise Linux operating system must be configured so that all networked systems have SSH installed."
#   yum:
#       name:
#           - openssh-server
#       state: present
#   tags:
#       - RHEL-07-040300
#       - CAT-II

- name: "CAT II | RHEL-07-040310 | The Red Hat Enterprise Linux operating system must be configured so that all networked systems use SSH for confidentiality and integrity of transmitted and received information as well as information during preparation for transmission."
  service:
      name: sshd
      state: started
      enabled: yes
  tags:
      - RHEL-07-040310
      - CAT-II

- name: "CAT II | RHEL-07-040320 | The Red Hat Enterprise Linux operating system must be configured so that all network connections associated with SSH traffic are terminated at the end of the session or after 10 minutes of inactivity, except to fulfill documented and validated mission requirements."
  lineinfile:
      create: yes
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?ClientAliveInterval"
      line: ClientAliveInterval 600
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  tags:
      - RHEL-07-040320
      - CAT-II

- name: "CAT II | RHEL-07-040330 | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon does not allow authentication using RSA rhosts authentication."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?RhostsRSAAuthentication"
      line: RhostsRSAAuthentication no
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  tags:
      - RHEL-07-040330
      - CAT-II

- name: "CAT II | RHEL-07-040340 | The Red Hat Enterprise Linux operating system must be configured so that all network connections associated with SSH traffic terminate after a period of inactivity."
  lineinfile:
      create: yes
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?ClientAliveCountMax"
      line: ClientAliveCountMax 0
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  tags:
      - RHEL-07-040340
      - CAT-II

- name: "CAT II | RHEL-07-040350 | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon does not allow authentication using rhosts authentication."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?IgnoreRhosts"
      line: IgnoreRhosts yes
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  tags:
      - RHEL-07-040350
      - CAT-II

- name: "CAT II | RHEL-07-040360 | The Red Hat Enterprise Linux operating system must display the date and time of the last successful account logon upon an SSH logon."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?PrintLastLog"
      line: PrintLastLog yes
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  tags:
      - RHEL-07-040360
      - CAT-II

- name: "CAT II | RHEL-07-040370 | The Red Hat Enterprise Linux operating system must not permit direct logons to the root account using remote access via SSH."
  lineinfile:
      create: yes
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?PermitRootLogin"
      line: PermitRootLogin no
      insertafter: '(?i)^#?authentication'
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  tags:
      - RHEL-07-040370
      - CAT-II

- name: "CAT II | RHEL-07-040380 | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon does not allow authentication using known hosts authentication."
  lineinfile:
      create: yes
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?IgnoreUserKnownHosts"
      line: IgnoreUserKnownHosts yes
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  tags:
      - RHEL-07-040380
      - CAT-II

- name: "CAT II | RHEL-07-040400 | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon is configured to only use Message Authentication Codes (MACs) employing FIPS 140-2 approved cryptographic hash algorithms."
  lineinfile:
      create: yes
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?MACs"
      line: MACs hmac-sha2-256,hmac-sha2-512
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  tags:
      - CAT-II
      - RHEL-07-040400

- name: "CAT II | RHEL-07-040410 | The Red Hat Enterprise Linux operating system must be configured so that the SSH public host key files have mode 0644 or less permissive."
  block:
      - name: "CAT II | RHEL-07-040410 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that the SSH public host key files have mode 0644 or less permissive."
        find:
            paths: /etc/ssh
            recurse: yes
            file_type: file
            patterns: 'ssh_host*_key.pub'
            hidden: true
        failed_when: no
        changed_when: no
        register: rhel_07_040410_audit

      - name: "CAT II | RHEL-07-040410 | The Red Hat Enterprise Linux operating system must be configured so that the SSH public host key files have mode 0644 or less permissive."
        file:
            dest: "{{ item.path }}"
            mode: 0644
            state: file
        with_items: "{{ rhel_07_040410_audit.files | default([]) }}"
  tags:
      - RHEL-07-040410
      - CAT-II

- name: "CAT II | RHEL-07-040420 | The Red Hat Enterprise Linux operating system must be configured so that the SSH private host key files have mode 0640 or less permissive."
  block:
      - name: "CAT II | RHEL-07-040420 | AUDIT | The Red Hat Enterprise Linux operating system must be configured so that the SSH private host key files have mode 0640 or less permissive."
        find:
            paths: /etc/ssh
            recurse: yes
            file_type: file
            patterns: 'ssh_host*_key'
            hidden: true
        failed_when: no
        changed_when: no
        register: rhel_07_040420_audit

      - name: "CAT II | RHEL-07-040420 | The Red Hat Enterprise Linux operating system must be configured so that the SSH private host key files have mode 0640 or less permissive."
        file:
            dest: "{{ item.path }}"
            mode: 0640
            state: file
        with_items: "{{ rhel_07_040420_audit.files | default([]) }}"
  tags:
      - RHEL-07-040420
      - CAT-II

- name: "CAT II | RHEL-07-040430 | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon does not permit Generic Security Service Application Program Interface (GSSAPI) authentication unless needed."
  lineinfile:
      create: yes
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?GSSAPIAuthentication"
      line: GSSAPIAuthentication no
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  tags:
      - RHEL-07-040430
      - CAT-II

- name: "CAT II | RHEL-07-040440 | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon does not permit Kerberos authentication unless needed."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?KerberosAuthentication"
      line: KerberosAuthentication no
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  tags:
      - RHEL-07-040440
      - CAT-II

- name: "CAT II | RHEL-07-040450 | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon performs strict mode checking of home directory configuration files."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?StrictModes"
      line: StrictModes yes
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  tags:
      - RHEL-07-040450
      - CAT-II

- name: "CAT II | RHEL-07-040460 | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon uses privilege separation."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?UsePrivilegeSeparation"
      line: UsePrivilegeSeparation sandbox
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  tags:
      - RHEL-07-040460
      - CAT-II

- name: "CAT II | RHEL-07-040470 | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon does not allow compression or only allows compression after successful authentication."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?Compression"
      line: Compression no
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  tags:
      - RHEL-07-040470
      - CAT-II

# - name: "CAT II	| RHEL-07-040520 | The Red Hat Enterprise Linux operating system must enable an application firewall, if available."
#   block:
#     - name: "Make sure firewalld is installed"
#       yum:
#         name: firewalld
#         state: present
#     - name: "Make sure firewall is running and enabled"
#       service:
#         name: firewalld
#         enabled: yes
#         state: started
#   tags:
#     - CAT II
#     - RHEL-07-040520

- name: "CAT III | RHEL-07-040530 | The Red Hat Enterprise Linux operating system must display the date and time of the last successful account logon upon logon."
  block:
      - name: "make sure lastlog.so is there"
        pamd:
            name: postlogin
            type: session
            control: required
            module_path: pam_lastlog.so
            state: updated
      - name: "make sure lastlog.so is there"
        pamd:
            name: postlogin
            type: session
            control: required
            module_path: pam_lastlog.so
            module_arguments: showfailed
            state: args_present

      - name: "correct the arguements"
        pamd:
            name: postlogin
            state: args_absent
            type: session
            control: "{{ item }}"
            module_path: pam_lastlog.so
            module_arguments: silent
        with_items:
            - '[default=1]'
            - 'optional'
            - '[success=1 default=ignore]'
            - 'required'
            - 'sufficient'
  tags:
    - CAT-I
    - RHEL-07-040530

- name: "CAT I | RHEL-07-040540 | The Red Hat Enterprise Linux operating system must not contain .shosts files."
  block:
      - name: "find all .shosts"
        command: find / -xdev -name '.shosts'
        check_mode: no
        changed_when: no
        register: rhel_07_040540_audit

      - name: "remove all .shost"
        file:
            path: "{{ item }}"
            state: absent
        with_items: "{{ rhel_07_040540_audit.stdout_lines }}"
  tags:
      - RHEL-07-040540
      - CAT-I

- name: "CAT I | RHEL-07-040550 | The Red Hat Enterprise Linux operating system must not contain shosts.equiv files."
  block:
      - name: "find all shosts.equiv"
        command: find / -xdev -name 'shosts.equiv'
        check_mode: no
        changed_when: no
        register: rhel_07_040550_audit

      - name: "remove all shosts.equiv"
        file:
            path: "{{ item }}"
            state: absent
        with_items: "{{ rhel_07_040550_audit.stdout_lines }}"
  tags:
      - RHEL-07-040550
      - CAT-I

- name: "CAT II | RHEL-07-040610 | The Red Hat Enterprise Linux operating system must not forward Internet Protocol version 4 (IPv4) source-routed packets."
  sysctl:
      name: net.ipv4.conf.all.accept_source_route
      state: present
      value: 0
      reload: yes
      ignoreerrors: yes
  tags:
      - RHEL-07-040610
      - CAT-II

- name: "CAT II | RHEL-07-040611 | The Red Hat Enterprise Linux operating system must use a reverse-path filter for IPv4 network traffic when possible on all interfaces."
  sysctl:
      name: net.ipv4.conf.all.rp_filter
      state: present
      value: '1'
      reload: yes
      ignoreerrors: yes
  tags:
      - RHEL-07-040611
      - CAT-II

- name: "CAT II | RHEL-07-040612 | The Red Hat Enterprise Linux operating system must use a reverse-path filter for IPv4 network traffic when possible by default."
  sysctl:
      name: net.ipv4.conf.default.rp_filter
      state: present
      value: '1'
      reload: yes
      ignoreerrors: yes
  tags:
      - RHEL-07-040612
      - CAT-II

- name: "CAT II | RHEL-07-040620 | The Red Hat Enterprise Linux operating system must not forward Internet Protocol version 4 (IPv4) source-routed packets by default."
  sysctl:
      name: net.ipv4.conf.default.accept_source_route
      state: present
      value: 0
      reload: yes
      ignoreerrors: yes
  tags:
      - RHEL-07-040620
      - CAT-II

- name: "CAT II | RHEL-07-040630 | The Red Hat Enterprise Linux operating system must not respond to Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) echoes sent to a broadcast address."
  sysctl:
      name: net.ipv4.icmp_echo_ignore_broadcasts
      state: present
      value: 1
      sysctl_set: yes
      reload: yes
      ignoreerrors: yes
  tags:
      - RHEL-07-040630
      - CAT-II

- name: "CAT II | RHEL-07-040640 | The Red Hat Enterprise Linux operating system must prevent Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirect messages from being accepted."
  sysctl:
      name: net.ipv4.conf.default.accept_redirects
      state: present
      value: 0
      reload: yes
      ignoreerrors: yes
  tags:
      - RHEL-07-040640
      - CAT-II

- name: "CAT II | RHEL-07-040641 | The Red Hat Enterprise Linux operating system must ignore Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirect messages"
  sysctl:
      name: net.ipv4.conf.all.accept_redirects
      state: present
      value: 0
      reload: yes
      ignoreerrors: yes
  tags:
      - RHEL-07-040641
      - CAT-II

- name: "CAT II | RHEL-07-040650 |  The Red Hat Enterprise Linux operating system must not allow interfaces to perform Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirects by default."
  sysctl:
      name: net.ipv4.conf.default.send_redirects
      state: present
      value: 0
      reload: yes
      ignoreerrors: yes
  tags:
      - RHEL-07-040650
      - CAT-II

- name: "CAT II | RHEL-07-040660 | The Red Hat Enterprise Linux operating system must not send Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirects."
  sysctl:
      name: net.ipv4.conf.all.send_redirects
      state: present
      value: 0
      reload: yes
      ignoreerrors: yes
  tags:
      - RHEL-07-040660
      - CAT-II

- name: "CAT II | RHEL-07-040670 | Network interfaces configured on the Red Hat Enterprise Linux operating system must not be in promiscuous mode."
  block:
      - name: "register all nics for promiscuous mode"
        shell: "ip link | grep -i promisc | cut -d ':' -f 2"
        check_mode: no
        failed_when: no
        changed_when: rhel_07_040670_promisc_check.stdout != ''
        ignore_errors: yes
        register: rhel_07_040670_promisc_check

      - name: "turn off promiscuous mode"
        shell: "ip link set dev {{ item }} promisc off"
        with_items: "{{ rhel_07_040670_promisc_check.stdout_lines }}"
  tags:
      - RHEL-07-040670
      - CAT-II

- name: "CAT II | RHEL-07-040680 | The Red Hat Enterprise Linux operating system must be configured to prevent unrestricted mail relaying."
  block:
      - name: "register if postfix is there"
        command: rpm -q postfix
        failed_when: no
        check_mode: no
        changed_when: no
        register: rhel_07_040680_rpm_audit

      - name: "register the settings"
        command: "/usr/sbin/postconf -n smtpd_client_restrictions"
        check_mode: no
        changed_when: no
        register: rhel_07_040680_postconf_audit
        when: rhel_07_040680_rpm_audit.rc == 0

      - name: "correct the settings if needed"
        command: "/usr/sbin/postconf -e 'smtpd_client_restrictions=permit_mynetworks, reject'"
        when:
            - rhel_07_040680_rpm_audit.rc == 0
            - rhel_07_040680_postconf_audit.stdout != 'smtpd_client_restrictions = permit_mynetworks, reject'
  tags:
      - RHEL-07-040680
      - CAT-II

- name: "CAT I | RHEL-07-040690 | The Red Hat Enterprise Linux operating system must not have a File Transfer Protocol (FTP) server package installed unless needed."
  yum:
      name: vsftpd
      state: absent
  tags:
      - RHEL-07-040690
      - CAT-I

- name: CAT I | RHEL-07-040700 | The Red Hat Enterprise Linux operating system must not have the Trivial File Transfer Protocol (TFTP) server package installed if not required for operational support."
  yum:
      name:
          - tftp-server
      state: absent
  tags:
      - RHEL-07-040700
      - CAT-I

- name: CAT I | RHEL-07-040710 | The Red Hat Enterprise Linux operating system must be configured so that remote X connections for interactive users are encrypted."
  lineinfile:
      create: yes
      dest: /etc/ssh/sshd_config
      regexp: "(?i)^#?X11Forwarding"
      line: X11Forwarding yes
      validate: /usr/sbin/sshd -t -f %s
  notify: restart sshd
  tags:
      - RHEL-07-040710
      - CAT-I

- name: "CAT II | RHEL-07-040740 | The Red Hat Enterprise Linux operating system must not be performing packet forwarding unless the system is a router."
  sysctl:
      name: net.ipv4.ip_forward
      state: present
      value: 0
      reload: yes
      ignoreerrors: yes
  tags:
      - RHEL-07-040740
      - CAT-II

- name: CAT I | RHEL-07-040800 | SNMP community strings on the Red Hat Enterprise Linux operating system must be changed from the default."
  block:
      - name: "compile a list of public and private in snmpd.conf"
        command: grep {{ item }} /etc/snmp/snmpd.conf
        check_mode: no
        failed_when: no
        changed_when: no
        with_items:
            - public
            - private
        register: rhel_07_040800_audit

      - name: "replace public and private"
        replace:
            dest: /etc/snmp/snmpd.conf
            regexp: (^com2sec.*default\s+)(public|private)
            replace: Endgam3Ladyb0g
        with_items: "{{ rhel_07_040800_audit.results }}"
        notify: restart snmpd
        when: item.stdout_lines | length > 0
  tags:
      - RHEL-07-040800
      - CAT-I


- name: "CAT II | RHEL-07-040830 | The Red Hat Enterprise Linux operating system must not forward IPv6 source-routed packets."
  sysctl:
      name: net.ipv6.conf.all.accept_source_route
      state: present
      value: 0
      reload: yes
      ignoreerrors: yes
  tags:
      - RHEL-07-040830
      - CAT-II
